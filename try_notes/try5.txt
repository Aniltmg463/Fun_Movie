//try5



<?php 
include('../connect.php');

if(!isset($_SESSION['uid'])){
  echo "<script> window.location.href='../login.php';  </script>";
  exit(); // Stop executing further code
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking</title>
</head>
<body>

<?php include('header.php') ?>

<div class="container" style="margin-top:100px!important;">
  <form action="viewallbooking.php" method="post">
    <div class="row">
      <div class="col-lg-3">
        <input type="date" name="start" class="form-control">
      </div>
      <div class="col-lg-3">
        <input type="date" name="end" class="form-control">
      </div>
      <div class="col-lg-3">
         <select name="status" id="" class="form-control">
          <option value="">Select Status</option>
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
         </select>
      </div>
      <div class="col-lg-3">
        <input type="submit" name="btnsearch" value="Search" class="btn btn-success">
      </div>
    </div>
  </form>
</div>

<div class="container">
   
  <div class="row mt-5">
    <div class="col-lg-12">
      <table class="table">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Category</th>
          <th>Date</th>
          <th>Time</th>
          <th>Seat Number</th>
          <th>Total Price</th>
          <th>Booking Date</th>
          <th>User</th>
          <th>Image</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
        
        <?php
        if(isset($_POST['btnsearch'])){
          $start  = $_POST['start'];
          $end    = $_POST['end'];
          $status = $_POST['status'];
  
          $total_sale = 0;
  
          $sql = "SELECT booking.bookingid, booking.show_date, booking.show_time, booking.seat_num, booking.total_price, booking.booking_date, users.name as 'username', booking.status, movies.title, categories.catname, tb_upload.image
          FROM booking
          INNER JOIN users ON users.userid = booking.user_id
          INNER JOIN movies ON movies.movieid = booking.movie_id
          INNER JOIN categories ON categories.catid = movies.catid
          INNER JOIN tb_upload ON tb_upload.id = booking.bookingid
          WHERE booking.show_date BETWEEN '$start' AND '$end' AND booking.status = '$status'";
          $res  = mysqli_query($con, $sql);
          if(mysqli_num_rows($res) > 0){
            while($data = mysqli_fetch_array($res)){
              $total_sale = $total_sale + $data['total_price'];
  
              ?>
              <tr>
                <td><?= $data['bookingid'] ?></td>
                <td><?= $data['title'] ?></td>
                <td><?= $data['catname'] ?></td>
                <td><?= $data['show_date'] ?></td>
                <td><?= $data['show_time'] ?></td>
                <td><?= $data['seat_num'] ?></td>
                <td><?= $data['total_price'] ?></td>
                <td><?= $data['booking_date'] ?></td>
                <td><?= $data['username'] ?></td>
                <!-- Display the image -->
                <td>
                    <?php if (!empty($data['image'])): ?>
                        <img src="../img/<?= $data['image'] ?>" alt="Booking Image" style="max-width: 100px; max-height: 100px;">
                    <?php else: ?>
                        No Image
                    <?php endif; ?>
                </td>
                <td>
                  <?php
                  if($data['status'] == 'Pending'){
                    echo "<a href='#' class='btn btn-warning' > Pending </a>";
                  }else{
                    echo "<a href='#' class='btn btn-success' > Approved </a>";
                  }
                  ?>
                </td>
                <td>
                  <?php
                  if($data['status'] == 'Approved'){
                    echo "<button type='button' class='btn btn-light' disabled> Completed </button>";
                    echo "<a href='viewallbooking.php?editbookingid=".$data['bookingid']."' class='btn btn-warning'> Edit</a>";
                    echo "<a href='viewallbooking.php?deletebookingid=".$data['bookingid']."' class='btn btn-danger' onclick='return confirm(\"Are you sure you want to delete this booking?\")'> Delete</a>";
                  }else{
                    echo "<a href='viewallbooking.php?bookingid=".$data['bookingid']."' class='btn btn-primary'> Approve</a>";
                    echo "<a href='viewallbooking.php?editbookingid=".$data['bookingid']."' class='btn btn-warning'> Edit</a>";
                    echo "<a href='viewallbooking.php?deletebookingid=".$data['bookingid']."' class='btn btn-danger' onclick='return confirm(\"Are you sure you want to delete this booking?\")'> Delete</a>";
                  }
                  ?>
                </td>
              </tr>
              <?php
            }
            echo "<tr> <td>Total Sale: <strong> Rs.".$total_sale." </strong></td> </tr>";
          }
        }else{
          $sql = "SELECT booking.bookingid, booking.show_date, booking.show_time, booking.seat_num, booking.total_price, booking.booking_date, users.name as 'username', booking.status, movies.title, categories.catname, tb_upload.image
          FROM booking
          INNER JOIN users ON users.userid = booking.user_id
          INNER JOIN movies ON movies.movieid = booking.movie_id
          INNER JOIN categories ON categories.catid = movies.catid
          INNER JOIN tb_upload ON tb_upload.id = booking.bookingid";
          $res  = mysqli_query($con, $sql);
          if(mysqli_num_rows($res) > 0){
            while($data = mysqli_fetch_array($res)){
              ?>
              <tr>
                <td><?= $data['bookingid'] ?></td>
                <td><?= $data['title'] ?></td>
                <td><?= $data['catname'] ?></td>
                <td><?= $data['show_date'] ?></td>
                <td><?= $data['show_time'] ?></td>
                <td><?= $data['seat_num'] ?></td>
                <td><?= $data['total_price'] ?></td>
                <td><?= $data['booking_date'] ?></td>
                <td><?= $data['username'] ?></td>
                <!-- Display the image -->
                <td>
                    <?php if (!empty($data['image'])): ?>
                        <img src="../img/<?= $data['image'] ?>" alt="Booking Image" style="max-width: 100px; max-height: 100px;">
                    <?php else: ?>
                        No Image
                    <?php endif; ?>
                </td>
                <td>
                  <?php
                  if($data['status'] == 'Pending'){
                    echo "<a href='#' class='btn btn-warning' > Pending </a>";
                  }else{
                    echo "<a href='#' class='btn btn-success' > Approved </a>";
                  }
                  ?>
                </td>
                <td>
                  <?php
                  if($data['status'] == 'Approved'){
                    echo "<button type='button' class='btn btn-light' disabled> Completed </button>";
                    echo "<a href='viewallbooking.php?editbookingid=".$data['bookingid']."' class='btn btn-warning'> Edit</a>";
                    echo "<a href='viewallbooking.php?deletebookingid=".$data['bookingid']."' class='btn btn-danger' onclick='return confirm(\"Are you sure you want to delete this booking?\")'> Delete</a>";
                  }else{
                    echo "<a href='viewallbooking.php?bookingid=".$data['bookingid']."' class='btn btn-primary'> Approve</a>";
                    echo "<a href='viewallbooking.php?editbookingid=".$data['bookingid']."' class='btn btn-warning'> Edit</a>";
                    echo "<a href='viewallbooking.php?deletebookingid=".$data['bookingid']."' class='btn btn-danger' onclick='return confirm(\"Are you sure you want to delete this booking?\")'> Delete</a>";
                  }
                  ?>
                </td>
              </tr>
              <?php
            }
          }
        }
        ?>
      </table>
    </div>
  </div>
</div>

<?php include('footer.php') ?>

</body>
</html>
