//try1 seats.php in justtry1.3
//output throw invalid request now this issue is solved



<?php
// Include your database connection file (connect.php)
include('connect.php');

// Check if the user is not logged in
if (!isset($_SESSION['uid'])) {
    echo "<script> window.location.href='login.php';  </script>";
    exit; // Stop further execution
}

// Initialize variables
$title = $description = $releasedate = $rating = $catid = '';

// Check if movie ID is provided
if (isset($_POST['selected_date'], $_POST['selected_show_time'], $_POST['movie_id'])) {
    $selected_date = $_POST['selected_date'];
    $selected_show_time = $_POST['selected_show_time'];
    $movie_id = $_POST['movie_id'];
    
    // Retrieve movie details based on movie ID
    $sql = "SELECT * FROM movies WHERE movieid = ?";
    $stmt = $con->prepare($sql); 
    $stmt->bind_param("i", $movie_id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($result && $result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $title = $row['title'];
        $description = $row['description'];
        $releasedate = $row['releasedate'];
        $rating = $row['rating'];
        $catid = $row['catid'];
    } else {
        echo "No movie found.";
        exit;
    }
} else {
    echo "Required data not provided.";
    exit;
}

// Check if form is submitted
if(isset($_POST['submit'])) {
    // Check if seats are selected
    if (!isset($_POST['seats']) || empty($_POST['seats'])) {
        // Use JavaScript to show a pop-up box
        echo '<script>alert("Please select at least one seat.");</script>';
    } else {
        // Redirect to confirm_booking.php if seats are selected
        header("Location: confirm_booking.php?selected_date=$selected_date&selected_show_time=$selected_show_time&movie_id=$movie_id");
        exit;
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Seat Selection</title>
    <link rel="stylesheet" href="seats.css">
    <style>
        h1, h2, h3 {
             margin: 0;
             padding: 10px 0;
            text-align: center; /* Center align the headings */
        }
         .seat-grid {
            display: grid;
            grid-template-columns: repeat(5, auto);
            grid-gap: 100px; /* Gap between columns */
            grid-row-gap: 10px; /* Decrease the gap between rows to 10px */
            justify-content: center; /* Center the grid horizontally */
            align-items: center; /* Center the grid vertically */
        }
        .seat-label {
            display: block;
            position: relative;
            padding-left: 30px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 18px;
            user-select: none;
        }
        .seat-label input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        .seat-checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 25px;
            width: 25px;
            background-color: green; /* if seat is empty */
            border: 1px solid #999;
            border-radius: 3px;
        }
        .seat-label input:checked ~ .seat-checkmark {
            background-color: #2196F3;
        }
        .seat-label input:disabled ~ .seat-checkmark {
            background-color: red; /* if seat is booked color is red */
            cursor: not-allowed;
        }
        .seat-checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }
        .seat-label input:checked ~ .seat-checkmark:after {
            display: block;
        }
        .seat-label .seat-checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg); 
        }

        /* Showcase styling */
        .showcase {
            list-style-type: none;
            padding: 0;
            display: flex;
            justify-content: center; /* Center the content horizontally */
        }
        .showcase li {
            display: inline-block;
            margin-right: 10px;
        }
        .showcase .seat {
            width: 25px;
            height: 25px;
            border: 1px solid #999;
            display: inline-block;
            margin-right: 5px;
            background-color: green;   /* empty seat indicate red */
        }
        .showcase .selected {
            background-color: #2196F3; /* selected indicate red */
        }
        .showcase .sold {
            background-color: red; /* sold indicate red */
        }


        /* styling fieldset */
        fieldset {
    border: 2px solid #ccc; /* Add a border */
    padding: 10px; /* Add some padding */
    margin: 20px auto; /* Center the fieldset */
    max-width: 500px; /* Limit the width */
                    }
legend {
    font-size: 1.2em; /* Increase the font size of the legend */
    font-weight: bold; /* Make the legend bold */
}
    </style>
</head>
<body>
    <h1>Seat Selection</h1>
    <h2><?php echo $title; ?></h2>
    <h3>Date: <?php echo $selected_date; ?>, Show Time: <?php echo $selected_show_time; ?></h3>
    <!-- Rest of the HTML content -->
    <form action="confirm_booking.php" method="post">
    <!-- Hidden fields -->
    <input type="hidden" name="selected_date" value="<?php echo $selected_date; ?>">
    <input type="hidden" name="selected_show_time" value="<?php echo $selected_show_time; ?>">
    <input type="hidden" name="movie_id" value="<?php echo $movie_id; ?>">

    <div class="screen"></div>
    
    <fieldset>
        <legend>Select Seats:</legend>
        <div class="seat-grid">
            <?php
            $total_seats = 35; // Assuming there are 35 seats
            for ($i = 1; $i <= $total_seats; $i++) {
                // Check if seat is booked and has status 'approved' or 'pending'
                $sql_check_seat = "SELECT COUNT(*) as total FROM booking WHERE movie_id = ? AND show_date = ? AND show_time = ? AND seat_num = ? AND status IN ('approved', 'pending')";
                $stmt_check_seat = $con->prepare($sql_check_seat);
                $stmt_check_seat->bind_param("isii", $movie_id, $selected_date, $selected_show_time, $i);
                $stmt_check_seat->execute();
                $result_check_seat = $stmt_check_seat->get_result();
                $row_check_seat = $result_check_seat->fetch_assoc();

                // If the seat is already booked, disable it
                $disabled = ($row_check_seat['total'] > 0) ? 'disabled' : '';
                echo "<label class='seat-label'><input type='checkbox' name='seats[]' value='$i' $disabled> Seat $i<span class='seat-checkmark'></span></label>";
            }
            ?>
        </div>
    </fieldset>
    <div style="margin-top: 20px; 20px; display: flex; justify-content: center;">
    <input type="submit" name="submit" value="Confirm Booking" style="margin-right: 20px;">
        <button type="button" onclick="window.location.href='index.php';">Cancel Booking</button>
    </div>
</form>

</body>
</html>
